"""
DO NOT MODIFY THIS FILE.  It is automatically generated and changes will be over-written
on the next generation.

This is the Server for the {{stinger.name}} interface.
"""

import json
from connection import BrokerConnection
{%if stinger.uses_enums()%}import {{stinger.get_enum_module_name()}} as {{stinger.get_enum_module_alias()}}{%endif%}

class {{stinger.name}}Server(object):

    def __init__(self, connection: BrokerConnection):
        self._conn = connection
        self._conn.set_last_will(topic="{{stinger.interface_info.0}}", payload=None, qos=1, retain=True)
        {%for p,v in stinger.params.items()-%}
        self._{{p}} = {{v.payload.initialValue}}
        self._conn.subscribe("{{topics.get_param_value(stinger.name, false, p)}}", self.set_{{p}})
        self.changed_value_callback_for_{{p}} = None
        self._publish_interface_info()
        {%endfor%}
    
    def _publish_interface_info(self):
        self._conn.publish("{{stinger.interface_info.0}}", '''{{stinger.interface_info.1 | tojson}}''', qos=1, retain=True)

    {%for sig_name, sig in stinger.signals.items()-%}
    def emit_{{sig_name}}(self, {%for arg in sig.arg_list%}{{arg.name}}: {{arg.python_type}}{%if not loop.last%}, {%endif%}{%endfor%}):
        {%for arg in sig.arg_list%}
        if not isinstance({{arg.name}}, {{arg.python_type}}):
            raise ValueError(f"The '{{arg.name}}' value must be {{arg.python_type}}.")
        {%-endfor%}
        
        payload = { {%-for arg in sig.arg_list%}
            {%if arg.arg_type.name.lower() == 'value'%}"{{arg.name}}": {{arg.python_type}}({{arg.name}}),{%endif-%}
            {%if arg.arg_type.name.lower() == 'enum'%}"{{arg.name}}": {{arg.python_type}}({{arg.name}}).value,{%endif%}{%endfor%}
        }
        self._conn.publish("{{sig.topic}}", json.dumps(payload), qos=1, retain=False)

    {%endfor%}

    {%for p,v in stinger.params.items()-%}
    {%-set args = payload(v['payload']) %}
    def set_{{p}}(self, {%for arg in args%}{{arg.name}}{%if not loop.last%}, {%endif%}{%endfor%}):
        changed = False
        {%for arg in payload(v['payload'])-%}
        if {{arg.name}} != self._{{p}}['{{arg.name}}']:
            changed = True
            self._{{p}}['{{arg.name}}'] = {{arg.name}}
        {%endfor-%}
        if changed:
            topic = "{{topics.get_param_value(stinger.name, false, p)}}"
            self._conn.publish(topic, self._{{p}}, 1, True)
            if self.changed_value_callback_for_{{p}} is not None:
                self.changed_value_callback_for_{{p}}({%for arg in args%}{{arg.name}}{%if not loop.last%}, {%endif%}{%endfor%})

    def get_{{p}}(self):
        {%if args | length > 1 -%}
        return self._{{p}}
        {%-else-%}
        return self._{{p}}[args[0].name]
        {%-endif%}
    {%endfor%}

if __name__ == '__main__':
    """
    This shows an example on how to run the code.  Ideally, your app should do something similar, but use the methods in
    a more meaningful way.
    """
    from time import sleep
    {%set broker = stinger.get_example_broker()%}
    from connection import {{broker.class_name}}

    conn = {{broker.class_name}}({%if broker.hostname is none%}'localhost', 1883{%endif%})
    server = {{stinger.name}}Server(conn)

    {%for sig_name, sig in stinger.signals.items()-%}
    server.emit_{{sig_name}}({%for arg in sig.arg_list%}{{arg.get_random_example_value()}}{%if not loop.last%}, {%endif%}{%endfor%})
    {%endfor%}

    sleep(4)

    {%for sig_name, sig in stinger.signals.items()-%}
    server.emit_{{sig_name}}({%for arg in sig.arg_list%}{{arg.name}}={{arg.get_random_example_value()}}{%if not loop.last%}, {%endif%}{%endfor%})
    {%endfor%}